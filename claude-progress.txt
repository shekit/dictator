# Dictator - Progress Log

This file tracks progress across coding sessions. Append new entries at the bottom.

---

## Session 0 - 2026-01-20 (Setup)
- Created harness system
- Created CLAUDE.md (agent instructions)
- Created ARCHITECTURE.md (project overview)
- Created features.json (9 phases, 54 features)
- Created init.sh (dev environment setup)
- Created this progress file

### Current State
- Harness system ready
- No code written yet
- Next: Phase 1, Feature 1.1 (Create Swift package)

---

## Session 1 - 2026-01-20 (Phase 1 Complete)
- Implemented all Phase 1 features (1.1 - 1.4)
- Created Swift package structure in Dictator/
- Created DictatorApp.swift (main entry point with SwiftUI App)
- Created AppDelegate.swift (app lifecycle management)
- Created StatusBarController.swift (menu bar icon and menu)
- Created Info.plist with LSUIElement=true (no Dock icon)
- Created build-app.sh script for packaging .app bundle

### Files Created
- Dictator/Package.swift
- Dictator/Sources/Dictator/App/DictatorApp.swift
- Dictator/Sources/Dictator/App/AppDelegate.swift
- Dictator/Sources/Dictator/UI/StatusBarController.swift
- Dictator/Sources/Dictator/Info.plist
- Dictator/build-app.sh

### Verification
- `swift build` succeeds without errors
- App bundle created at Dictator/Dictator.app
- Menu bar icon uses SF Symbol "mic.fill"
- Quit menu item terminates app
- LSUIElement configured (no Dock icon)

### Current State
- Phase 1 complete (4/4 features passing)
- Next: Phase 2, Feature 2.1 (Global hotkey registration)

---

## Session 2 - 2026-01-20 (Phase 2 Complete)
- Implemented all Phase 2 features (2.1 - 2.7)
- Created GlobalHotkeyManager for Ctrl+Option+Space detection using CGEvent tap
- Created AudioRecorder with AVAudioEngine for microphone capture
- Created RecordingService to coordinate hotkey + audio
- Updated StatusBarController with visual indicators

### Files Created
- Dictator/Sources/Dictator/Audio/GlobalHotkeyManager.swift
- Dictator/Sources/Dictator/Audio/AudioRecorder.swift
- Dictator/Sources/Dictator/Audio/RecordingService.swift

### Files Modified
- Dictator/Sources/Dictator/UI/StatusBarController.swift (added recording state icons)
- Dictator/Sources/Dictator/App/AppDelegate.swift (integrated RecordingService)

### Implementation Details
- CGEvent tap with health monitoring (re-enables if disabled by macOS)
- Thread-safe audio buffer with NSLock for concurrent access
- AVAudioEngine stored as AnyObject to avoid Combine reflection crashes
- Delayed initialization (1.5s) to avoid race conditions at launch
- Menu bar icon changes: mic.fill (idle) -> mic.circle.fill (recording) -> mic.slash.fill (error)
- Accessibility permission prompt via AXIsProcessTrustedWithOptions
- Microphone permission handling with helpful error messages

### Post-Implementation Updates
- Changed hotkey from Ctrl+Option+Space to **fn key** (hold to record)
- Added cancel behavior: fn + other key cancels recording (allows F1-F12 to work)
- Fixed permission handling:
  - Added permission polling timer to auto-detect when permission is granted
  - Removed NSAlert that was interfering with permission detection
  - App must be launched via `open ./Dictator.app` to properly gain permissions

### Verification
- `swift build` succeeds without errors
- App bundle created at Dictator/Dictator.app
- Hotkey: fn key (hold to record, release to stop, fn+other key cancels)
- Console logs show hotkey events and buffer sizes
- Menu bar icon changes during recording
- Graceful error handling for missing permissions

### Current State
- Phase 2 complete (7/7 features passing)
- Next: Phase 3, Feature 3.1 (Add FluidAudio dependency)

---

## Session 3 - 2026-01-20 (Phase 3 Complete)
- Implemented all Phase 3 features (3.1 - 3.6)
- Integrated FluidAudio library for speech-to-text transcription
- Created TranscriptionService to wrap AsrManager with proper serialization
- Updated RecordingService to transcribe audio after recording stops
- Added transcribing state and visual indicator to UI

### Files Created
- Dictator/Sources/Dictator/STT/TranscriptionService.swift

### Files Modified
- Dictator/Package.swift (added FluidAudio dependency from GitHub)
- Dictator/Sources/Dictator/Audio/RecordingService.swift (added transcription flow)
- Dictator/Sources/Dictator/UI/StatusBarController.swift (added transcribing state)
- Dictator/Sources/Dictator/App/AppDelegate.swift (model preloading, transcription callback)

### Implementation Details
- FluidAudio dependency: `https://github.com/FluidInference/FluidAudio` version 0.10.0
- Uses Parakeet TDT v2 model (~450MB) - downloads automatically on first run
- Models stored in `~/Library/Application Support/FluidAudio/Models/`
- TranscriptionExecutor actor serializes FluidAudio calls (CoreML requirement)
- Empty recording handling: rejects audio < 100ms (1600 samples at 16kHz)
- Menu bar icon: waveform.circle.fill during transcription
- Lazy model loading: starts in background at launch, ready for first transcription

### Verification
- `swift build` succeeds without errors
- `swift package resolve` fetches FluidAudio successfully
- Model files download to Application Support on first run
- App handles empty/silent recordings gracefully
- Menu bar shows transcribing state during processing

### Current State
- Phase 3 complete (6/6 features passing)
- Next: Phase 4, Feature 4.1 (Request Accessibility permission)

---

## Session 4 - 2026-01-20 (Phase 4 Complete)
- Implemented all Phase 4 features (4.1 - 4.6)
- Created TextInjectionService for clipboard-based text injection
- Full end-to-end flow now works: hold fn → speak → release → transcribe → inject text at cursor

### Files Created
- Dictator/Sources/Dictator/Injection/TextInjectionService.swift

### Files Modified
- Dictator/Sources/Dictator/Audio/RecordingService.swift (added injecting state, text injection call)
- Dictator/Sources/Dictator/UI/StatusBarController.swift (added injecting state UI)

### Implementation Details
- TextInjectionService uses singleton pattern (shared instance)
- Clipboard operations:
  1. saveClipboard() - stores all NSPasteboardItem data
  2. writeToClipboard() - writes transcription text
  3. restoreClipboard() - restores original clipboard contents
- Keystroke simulation uses CGEvent for Cmd+V
- Timing: 50ms delay before paste, 100ms delay before restore
- Accessibility permission check with helpful prompt and settings link
- Menu bar icon shows "text.cursor" SF Symbol during injection
- RecordingService.State now includes .injecting state

### Verification
- `swift build` succeeds without errors
- App bundle created at Dictator/Dictator.app
- Accessibility permission requested when needed
- Clipboard contents preserved and restored after injection
- Text appears at cursor position after speaking
- Full workflow: fn (hold) → speak → fn (release) → transcription → injection

### Current State
- Phase 4 complete (6/6 features passing)
- Next: Phase 5, Feature 5.1 (OpenRouter API client)

---

## Session 5 - 2026-01-20 (Phase 5 Complete)
- Implemented all Phase 5 features (5.1 - 5.9)
- Created OpenRouter API client for cloud LLM processing
- Created EnvLoader for .env file configuration
- Created LLMService with prompt system (main, advanced, dictionary)
- Added model selection and LLM toggle to menu bar

### Files Created
- Dictator/Sources/Dictator/Storage/EnvLoader.swift
- Dictator/Sources/Dictator/LLM/OpenRouterClient.swift
- Dictator/Sources/Dictator/LLM/LLMService.swift

### Files Modified
- Dictator/Sources/Dictator/Audio/RecordingService.swift (added LLM processing step)
- Dictator/Sources/Dictator/UI/StatusBarController.swift (added LLM toggle, model selection)
- Dictator/Sources/Dictator/App/AppDelegate.swift (EnvLoader initialization)

### Implementation Details
- EnvLoader reads .env from: app bundle dir, ~/.env, or ~/Documents/Dictator/.env
- OpenRouterClient with retry logic, rate limiting, and error handling
- 8 cloud models available: Groq Llama, Claude, GPT-4o, Gemini, Mistral
- LLMService.ProcessingMode: .cloud, .local (Phase 6), .off
- Main prompt removes fillers (um, uh, like, you know) and adds punctuation
- Advanced prompt (toggleable) handles backtracking/corrections
- Dictionary entries allow custom term replacements
- All settings persist via UserDefaults
- Graceful fallback to raw transcription on API errors

### Menu Bar Changes
- "LLM: Cloud: Llama 3.1 70B" status display
- "Enable/Disable LLM Processing" toggle
- "Cloud Model" submenu with checkmarked selection

### Verification
- `swift build` succeeds without errors
- App bundle created at Dictator/Dictator.app
- .env file loaded correctly at startup
- OpenRouter API calls work with valid key
- Model selection persists across restarts
- Toggle state persists across restarts
- Falls back to raw text on API error

### Current State
- Phase 5 complete (9/9 features passing)
- Next: Phase 6, Feature 6.1 (Check if Ollama is running)

---

## Session 6 - 2026-01-20 (Phase 6 Complete)
- Implemented all Phase 6 features (6.1 - 6.8)
- Created OllamaClient for local LLM processing
- Integrated Ollama with the existing 3-prompt system
- Added mode selection (Cloud/Local/Off) to menu bar
- Added local model selection with auto-discovery

### Files Created
- Dictator/Sources/Dictator/LLM/OllamaClient.swift

### Files Modified
- Dictator/Sources/Dictator/LLM/LLMService.swift (added Ollama integration)
- Dictator/Sources/Dictator/UI/StatusBarController.swift (added mode toggle, local model selection)

### Implementation Details
- OllamaClient: Actor-based HTTP client for Ollama API
  - Health check via /api/tags endpoint
  - Model listing with size and metadata
  - Generate endpoint with system prompt support
  - Comprehensive error handling (not running, no models, model not found)
- LLMService updates:
  - Added selectedLocalModel property with persistence
  - Added availableLocalModels list (auto-refreshed)
  - Added isOllamaAvailable flag
  - processWithOllama() uses same 3-prompt system as cloud
  - Ollama status refreshed on init and mode change
- StatusBarController updates:
  - Mode submenu: Cloud (OpenRouter) / Local (Ollama) / Off (Raw Text)
  - Cloud Model submenu: 8 OpenRouter models
  - Local Model submenu: Auto-populated from Ollama, shows model size
  - "[Offline]" indicator when in local mode with Ollama available
  - Warning dialogs when switching to unavailable mode

### Menu Bar Changes
- "Processing Mode" submenu with Cloud/Local/Off options
- "Cloud Model" submenu (enabled only in Cloud mode)
- "Local Model" submenu (enabled only in Local mode, shows installed models)
- Status line shows "[Offline]" indicator when using local processing

### Verification
- `swift build` succeeds without errors
- App bundle created at Dictator/Dictator.app
- Ollama detected at localhost:11434
- Local model (llama3.2:3b) discovered and selectable
- Mode selection persists across restarts
- Graceful error handling when Ollama not running

### Current State
- Phase 6 complete (8/8 features passing)
- Next: Phase 7, Feature 7.1 (Settings menu item opens window)

---

## Session 7 - 2026-01-21 (Phase 7 Complete)
- Implemented all Phase 7 features (7.1 - 7.10)
- Created comprehensive Settings window with SwiftUI tabbed interface
- Added Settings menu item to status bar (Cmd+,)

### Files Created
- Dictator/Sources/Dictator/UI/SettingsWindow.swift

### Files Modified
- Dictator/Sources/Dictator/UI/StatusBarController.swift (Settings menu item and window controller)

### Implementation Details
- SettingsWindow: SwiftUI view with 3 tabs (Prompts, Dictionary, Settings)
- PromptsTabView:
  - Main prompt editor (TextEditor with customization)
  - Reset to Default button
  - Advanced prompt section with enable/disable toggle
  - Read-only display of advanced prompt
- DictionaryTabView:
  - Add new dictionary entries (spoken → replacement)
  - Edit existing entries
  - Delete entries
  - List view of all entries
- SettingsTabView:
  - Hotkey configuration display (currently fixed to fn key)
  - API key status from .env file (shows configured/not configured + file path)
  - Processing Mode picker (Cloud/Local/Off)
  - Cloud Model picker (8 OpenRouter models, enabled only in Cloud mode)
  - Local Model picker (Ollama models with sizes, enabled only in Local mode)
  - Refresh Ollama Models button
- All settings persist via existing LLMService UserDefaults integration
- Custom prompts affect transcription via LLMService.buildSystemPrompt()
- Window management: Creates NSWindow with NSHostingController for SwiftUI content

### Verification
- `swift build` succeeds without errors
- Settings menu item appears in status bar dropdown
- Cmd+, keyboard shortcut works
- Settings window opens with all 3 tabs
- Main prompt can be edited and saved
- Advanced prompt toggle works
- Dictionary entries can be added, edited, and deleted
- API key status displays correctly
- Model pickers show appropriate options
- All settings persist across app restarts

### Current State
- Phase 7 complete (10/10 features passing)
- Next: Phase 8, Feature 8.1 (Calculate word count per transcription)

---


## Session 8 - 2026-01-21 (Phase 8 Complete)
- Implemented all Phase 8 features (8.1 - 8.9)
- Created comprehensive stats tracking and transcription logging system
- Added History and Stats tabs to Settings window
- Added today's stats display to menu bar

### Files Created
- Dictator/Sources/Dictator/Stats/StatsService.swift
- Dictator/Sources/Dictator/Stats/TranscriptionLogger.swift

### Files Modified
- Dictator/Sources/Dictator/App/AppDelegate.swift (stats and logging integration)
- Dictator/Sources/Dictator/UI/StatusBarController.swift (stats menu item)
- Dictator/Sources/Dictator/UI/SettingsWindow.swift (History and Stats tabs)

### Implementation Details
- StatsService: Singleton service for tracking usage statistics
  - Word count calculation from transcription text
  - WPM (words per minute) calculation from word count and duration
  - Daily stats aggregation with automatic rollover at midnight
  - Persistence via UserDefaults (last 365 days retained)
  - Today, week, and all-time aggregations
  - Published properties for SwiftUI observation
- TranscriptionLogger: Actor-based JSONL file logger
  - Logs to ~/Documents/Dictator/transcriptions.jsonl
  - Each entry contains: timestamp, rawText, cleanedText, wordCount, duration, wpm, mode, model
  - ISO 8601 timestamps with fractional seconds
  - Thread-safe async operations
  - Recent entries retrieval for UI display
- StatusBarController updates:
  - Added statsMenuItem showing "Today: X words | Y WPM"
  - Updates after each transcription via updateTodayStats()
  - Shows "No recordings yet" when count is 0
- SettingsWindow updates:
  - Added History tab with scrollable list of past transcriptions
  - Added Stats tab with today/week/all-time statistics in card layout
  - History shows: timestamp, word count, WPM, mode, cleaned text, raw text (if different)
  - Stats shows: total words, total recordings, average WPM for each time period
- AppDelegate integration:
  - onTranscriptionComplete callback records stats and logs to file
  - Automatically updates menu bar stats after each transcription
  - Captures mode and model info for logging

### Verification
- `swift build` succeeds without errors or warnings
- App bundle created at Dictator/Dictator.app
- Stats menu item shows "Today: No recordings yet" on fresh install
- History tab appears in Settings with all 5 tabs visible
- Stats tab shows beautiful stat cards with icons
- All stats properly calculated and displayed

### Current State
- Phase 8 complete (9/9 features passing)
- Next: Phase 9, Feature 9.1 (Sound feedback on recording start)

---
